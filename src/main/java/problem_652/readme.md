Идея О(n) в том, чтобы ввести каждому поддереву свой айди. У equals поддеревьев айди будет одинаковый, у !equals - разный.
Таким образом, в мапе будем хранить по triplet айдишник поддерева и кол-во встреч с ним.